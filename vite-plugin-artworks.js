import fs from 'fs'
import path from 'path'

/**
 * Vite plugin that auto-generates the artworks manifest
 * by scanning the /artworks folder for p*.js files
 */
export function artworksManifestPlugin() {
  const artworksDir = path.resolve('artworks')
  const manifestPath = path.resolve('src/artworks-manifest.js')

  function generateManifest() {
    try {
      const files = fs.readdirSync(artworksDir)
      
      // Filter for p*.js files and extract IDs
      const artworks = files
        .filter(file => /^p\d+\.js$/.test(file))
        .map(file => {
          const id = parseInt(file.match(/^p(\d+)\.js$/)[1])
          return { id, file }
        })
        .sort((a, b) => a.id - b.id)

      // Generate manifest content
      const content = `/**
 * Artwork Manifest (Auto-generated)
 * 
 * This file is automatically generated by vite-plugin-artworks.
 * To add a new artwork, simply create a p{n}.js file in the /artworks folder.
 * The manifest will be updated automatically on dev server start or build.
 */

export const artworks = [
${artworks.map(a => `  { id: ${a.id}, file: '${a.file}' }`).join(',\n')}
];

// Helper function to get artwork by id
export const getArtworkById = (id) => {
  return artworks.find(art => art.id === id);
};

// Helper function to get all artwork IDs
export const getAllArtworkIds = () => {
  return artworks.map(art => art.id);
};

// Helper function to get total count
export const getArtworkCount = () => {
  return artworks.length;
};
`

      fs.writeFileSync(manifestPath, content)
      console.log(`âœ“ Generated artworks manifest with ${artworks.length} artworks`)
    } catch (err) {
      console.error('Failed to generate artworks manifest:', err)
    }
  }

  return {
    name: 'artworks-manifest',
    
    // Generate on dev server start
    buildStart() {
      generateManifest()
    },

    // Watch for changes in artworks folder during dev
    configureServer(server) {
      server.watcher.add(artworksDir)
      server.watcher.on('add', (file) => {
        if (file.startsWith(artworksDir) && /^p\d+\.js$/.test(path.basename(file))) {
          generateManifest()
        }
      })
      server.watcher.on('unlink', (file) => {
        if (file.startsWith(artworksDir) && /^p\d+\.js$/.test(path.basename(file))) {
          generateManifest()
        }
      })
    }
  }
}

